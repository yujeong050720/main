<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>P2P ë§í¬-ì²´ì¸ ë°ëª¨</title>
  <style>
    body      { font-family: sans-serif; max-width: 640px; margin: 40px auto; }
    #chat li  { margin: 6px 0; }
    code      { background:#f2f2f2; padding:2px 4px; border-radius:4px; }
    pre       { background:#fafafa; padding:12px; overflow-x:auto; }
  </style>
</head>
<body>
  <h2>ë¸”ë¡ì²´ì¸-ê¸°ë°˜ ë§í¬ ì±„íŒ…ë°© ğŸš€</h2>

  <!-- â‘  ë§í¬ ì…ë ¥ UI -->
  <input id="linkInput" type="url" size="50" placeholder="https://example.com" />
  <button id="sendBtn">ì „ì†¡</button>

  <!-- â‘¡ ì±„íŒ…/ë§í¬ ë¦¬ìŠ¤íŠ¸ -->
  <h3>ë©”ì‹œì§€</h3>
  <ul id="chat"></ul>

  <!-- â‘¢ ë¸”ë¡ì²´ì¸ JSON ì¶œë ¥ -->
  <h3>ë¸”ë¡ì²´ì¸ ìƒíƒœ</h3>
  <pre id="chainView"></pre>

  <script type="module">
    /***********************
     * 1. Block ì •ì˜
     ***********************/
    class Block {
      constructor(index, timestamp, data, previousHash = '') {
        this.index        = index;
        this.timestamp    = timestamp;   // ISO-8601
        this.data         = data;        // { url: "..." }
        this.previousHash = previousHash;
        this.hash         = this.calculateHash();
      }
      calculateHash() {
        const msg = this.index + this.previousHash + this.timestamp +
                    JSON.stringify(this.data);

        let h = 0;
        for (let i = 0; i < msg.length; i++) {
          h = ((h << 5) - h) + msg.charCodeAt(i);
          h |= 0;
        }
        return (h >>> 0).toString(16);   // ë¶€í˜¸ ì—†ëŠ” 32-bit â†’ hex
      }
    }

    /***********************
     * 2. Blockchain ì •ì˜
     ***********************/
    class Blockchain {
      constructor() { this.chain = [this.createGenesisBlock()]; }
      createGenesisBlock() {
        return new Block(0, new Date().toISOString(), { url: 'GENESIS' }, '0');
      }
      getLatestBlock() { return this.chain[this.chain.length - 1]; }
      addBlock(newBlock) {
        newBlock.previousHash = this.getLatestBlock().hash;
        newBlock.hash         = newBlock.calculateHash();
        this.chain.push(newBlock);
      }
      isValid() {
        for (let i = 1; i < this.chain.length; i++) {
          const c = this.chain[i], p = this.chain[i - 1];
          if (c.hash !== c.calculateHash()) return false;
          if (c.previousHash !== p.hash)    return false;
        }
        return true;
      }
    }

    /***********************
     * 3. UI & ë¡œì§ ì—°ê²°
     ***********************/
    const bc        = new Blockchain();
    const $input    = document.getElementById('linkInput');
    const $send     = document.getElementById('sendBtn');
    const $chat     = document.getElementById('chat');
    const $chainOut = document.getElementById('chainView');

    // ë¸”ë¡ì²´ì¸ JSON & ì±„íŒ… ìƒˆë¡œ ê³ ì¹¨
    function refreshViews() {
      // â‘  ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸
      $chat.innerHTML = bc.chain
        .filter(b => b.index !== 0)               // ì œë„¤ì‹œìŠ¤ ì œì™¸
        .map(b => `<li><a href="${b.data.url}" target="_blank">${b.data.url}</a>
                   <small><code>#${b.index}</code></small></li>`)
        .join('');
      // â‘¡ ì²´ì¸ ì „ì²´
      $chainOut.textContent = JSON.stringify(bc, null, 2) +
        `\nìœ íš¨ì„±: ${bc.isValid()}`;
    }
    refreshViews();

    // â–¶ ì „ì†¡ ë²„íŠ¼ í´ë¦­
    $send.addEventListener('click', () => {
      const url = $input.value.trim();
      if (!url) return alert('URLì„ ì…ë ¥í•˜ì„¸ìš”!');
      // ê°„ë‹¨í•œ URL ìœ íš¨ì„± ê²€ì‚¬
      try { new URL(url); }
      catch { return alert('ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); }

      // ë¸”ë¡ ì¶”ê°€
      bc.addBlock(new Block(
        bc.chain.length,
        new Date().toISOString(),
        { url }
      ));
      $input.value = '';
      refreshViews();
    });

    // ì—”í„°í‚¤ë¡œë„ ì „ì†¡
    $input.addEventListener('keydown', e => {
      if (e.key === 'Enter') $send.click();
    });
  </script>
</body>
</html>
