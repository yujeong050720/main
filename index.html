<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>블록체인 데모</title>
  <style>
    body {font-family: monospace; max-width: 700px; margin: 40px auto;}
    pre  {background:#f4f4f4; padding:12px; border-radius:6px; overflow-x:auto;}
  </style>
</head>
<body>
  <h2>블록체인 상태</h2>
  <!-- (1) 결과를 뿌려 줄 자리 -->
  <pre id="chainView"></pre>

  <script>
  /*******************************************************
   *  1. Block 클래스 ― 간이 DJB2-32 해시 사용
   ******************************************************/
  class Block {
    constructor(index, timestamp, data, previousHash = '') {
      this.index = index;                 // 블록 번호
      this.timestamp = timestamp;         // ISO-8601 문자열
      this.data = data;                   // 아무 JS 객체
      this.previousHash = previousHash;   // 바로 앞 블록의 해시
      this.hash = this.calculateHash();   // 블록 생성 시 해시 1회 계산
    }
    calculateHash() {                     // DJB2 변형
      const msg = this.index + this.previousHash + this.timestamp +
                  JSON.stringify(this.data);
      let h = 0;
      for (let i = 0; i < msg.length; i++) {
        h = ((h << 5) - h) + msg.charCodeAt(i);
        h |= 0;                           // signed 32-bit
      }
      return (h >>> 0).toString(16);      // unsigned → hex
    }
  }

  /*******************************************************
   *  2. Blockchain 클래스
   ******************************************************/
  class Blockchain {
    constructor() { this.chain = [this.createGenesisBlock()]; }
    createGenesisBlock() {
      return new Block(0, new Date().toISOString(), 'Genesis Block', '0');
    }
    getLatestBlock() { return this.chain[this.chain.length - 1]; }
    addBlock(newBlock) {
      newBlock.previousHash = this.getLatestBlock().hash;
      newBlock.hash = newBlock.calculateHash();
      this.chain.push(newBlock);
    }
    isChainValid() {
      for (let i = 1; i < this.chain.length; i++) {
        const cur  = this.chain[i];
        const prev = this.chain[i - 1];
        if (cur.hash !== cur.calculateHash()) return false;
        if (cur.previousHash !== prev.hash)   return false;
      }
      return true;
    }
  }

  /*******************************************************
   *  3. 사용 예시
   ******************************************************/
  const myCoin = new Blockchain();
  myCoin.addBlock(new Block(1, new Date().toISOString(), { amount: 4 }));
  myCoin.addBlock(new Block(2, new Date().toISOString(), { amount: 10 }));

  // (4) 화면에 출력
  const out = document.getElementById('chainView');
  out.textContent =
    JSON.stringify(myCoin, null, 2) +
    '\n체인 유효성: ' + myCoin.isChainValid();
  </script>
</body>
</html>
