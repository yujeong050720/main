<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>P2P ë§í¬-ë¸”ë¡ì²´ì¸ ì±„íŒ…ë°©</title>
  <style>
    body{font-family:sans-serif;max-width:720px;margin:40px auto;padding:0 12px}
    h2{margin-top:0}
    #chat li{margin:6px 0}
    code{background:#f3f3f3;padding:2px 4px;border-radius:4px}
    pre{background:#fafafa;padding:12px;border-radius:6px;overflow-x:auto}
    .small{font-size:.85em;color:#777}
  </style>
</head>
<body>
  <h2>ğŸ”— P2P ë¸”ë¡ì²´ì¸ ë§í¬ ì±„íŒ…</h2>

  <!-- 1. ì…ë ¥ì°½ -->
  <input id="linkInput" type="url" size="50" placeholder="https://example.com" />
  <button id="sendBtn">ì „ì†¡</button>
  <span id="status" class="small"></span>

  <!-- 2. ì±„íŒ… ëª©ë¡ -->
  <h3>ë©”ì‹œì§€</h3>
  <ul id="chat"></ul>

  <!-- 3. ë¸”ë¡ì²´ì¸ JSON ë³´ê¸° -->
  <h3>ë¸”ë¡ì²´ì¸</h3>
  <pre id="chainView"></pre>

  <script type="module">
    /************ 0. ì™¸ë¶€ ëª¨ë“ˆ ë¡œë“œ (CDN) ************/
    import { createLibp2p }  from 'https://unpkg.com/libp2p@0.46.3/dist/esm/index.js';
    import { webRTC }        from 'https://unpkg.com/@libp2p/webrtc@0.5.0/dist/esm/index.js';
    import { gossipsub }     from 'https://unpkg.com/@chainsafe/libp2p-gossipsub@14.1.1/dist/esm/index.js';
    import { noise }         from 'https://unpkg.com/@chainsafe/libp2p-noise@11.0.2/dist/esm/index.js';
    import { mplex }         from 'https://unpkg.com/@libp2p/mplex@0.20.1/dist/esm/index.js';

    /************ 1. ê°„ë‹¨ Block / Blockchain ************/
    class Block{
      constructor(index, ts, data, prev='0'){
        this.index=index;
        this.timestamp=ts;
        this.data=data;
        this.previousHash=prev;
        this.hash=this.calc();
      }
      calc(){
        const src=this.index+this.previousHash+this.timestamp+JSON.stringify(this.data);
        let h=0;
        for(let i=0;i<src.length;i++){
          h=((h<<5)-h)+src.charCodeAt(i); h|=0;
        }
        return (h>>>0).toString(16);
      }
    }
    class Blockchain{
      constructor(){
        this.chain=[new Block(0,new Date().toISOString(),{url:'GENESIS'},'0')];
      }
      last(){return this.chain[this.chain.length-1];}
      addData(url){
        const b=new Block(this.chain.length,new Date().toISOString(),{url},this.last().hash);
        this.chain.push(b); return b;
      }
      isValid(arr=this.chain){
        for(let i=1;i<arr.length;i++){
          const c=arr[i],p=arr[i-1];
          if(c.hash!==new Block(c.index,c.timestamp,c.data,c.previousHash).hash) return false;
          if(c.previousHash!==p.hash) return false;
        }
        return true;
      }
    }

    /************ 2. UI ìš”ì†Œ ì°¸ì¡° ************/
    const $in=document.getElementById('linkInput');
    const $btn=document.getElementById('sendBtn');
    const $chat=document.getElementById('chat');
    const $view=document.getElementById('chainView');
    const $status=document.getElementById('status');

    /************ 3. ë¸”ë¡ì²´ì¸ ì¸ìŠ¤í„´ìŠ¤ ************/
    const chain=new Blockchain();
    refreshViews();

    /************ 4. libp2p ë…¸ë“œ ìƒì„± (WebRTC) ************/
    const node=await createLibp2p({
      transports:[webRTC()],
      connectionEncryption:[noise()],
      streamMuxers:[mplex()],
      pubsub:gossipsub(),
      addresses:{listen:[
        '/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star',
        '/dns4/wrtc-star2.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star'
      ]}
    });
    await node.start();
    $status.textContent=`ë‚´ PeerID: ${node.peerId.toString().slice(0,8)}â€¦`;

    const TOPIC='linkchain-room';
    node.pubsub.subscribe(TOPIC);

    /************ 5. P2P ë©”ì‹œì§€ ì²˜ë¦¬ ************/
    // ìƒˆ í”¼ì–´ì—ê²Œ ë‚´ ì²´ì¸ ë³´ë‚´ì£¼ê¸°
    node.addEventListener('peer:connect', ()=>broadcast({type:'SYNC',chain:chain.chain}));

    // ë©”ì‹œì§€ ìˆ˜ì‹ 
    node.pubsub.addEventListener('message', evt=>{
      const msg=JSON.parse(new TextDecoder().decode(evt.detail.data));
      if(msg.type==='NEW_BLOCK'){ handleBlock(msg.block); }
      else if(msg.type==='SYNC' && msg.chain?.length>chain.chain.length && chain.isValid(msg.chain)){
        chain.chain=msg.chain; refreshViews();
      }
    });

    function broadcast(obj){
      node.pubsub.publish(TOPIC,new TextEncoder().encode(JSON.stringify(obj)));
    }

    function handleBlock(b){
      const last=chain.last();
      const test=new Block(b.index,b.timestamp,b.data,b.previousHash);
      if(b.previousHash===last.hash && b.hash===test.hash){
        chain.chain.push(b); refreshViews();
      }
    }

    /************ 6. UI ì´ë²¤íŠ¸ ************/
    $btn.onclick=()=>{ if($in.value.trim()) sendLink($in.value.trim()); };
    $in.addEventListener('keydown',e=>{ if(e.key==='Enter') $btn.click(); });

    function sendLink(url){
      try{ new URL(url);}catch{return alert('ì˜¬ë°”ë¥¸ URL ì•„ë‹˜');}
      const blk=chain.addData(url);
      broadcast({type:'NEW_BLOCK',block:blk});
      $in.value=''; refreshViews();
    }

    /************ 7. í™”ë©´ ê°±ì‹  ************/
    function refreshViews(){
      // ì±„íŒ… ëª©ë¡
      $chat.innerHTML=chain.chain.slice(1).map(b=>{
        return `<li><a href="${b.data.url}" target="_blank">${b.data.url}</a>
                <code>#${b.index}</code></li>`;
      }).join('');
      // ë¸”ë¡ì²´ì¸ JSON
      $view.textContent=JSON.stringify(chain.chain,null,2)+
        `\nìœ íš¨ì„±: ${chain.isValid()}`;
    }
  </script>
</body>
</html>
